<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Argo Ocean AI Explorer</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet.js for mapping -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for chat */
        #chat-messages::-webkit-scrollbar {
            width: 8px;
        }
        #chat-messages::-webkit-scrollbar-track {
            background: #2d3748;
        }
        #chat-messages::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-radius: 10px;
            border: 2px solid #2d3748;
        }
        .message-bubble {
            max-width: 80%;
            word-wrap: break-word;
        }
        #map {
            height: 100%;
            width: 100%;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col h-screen antialiased">

    <!-- Header -->
    <header class="bg-gray-800 shadow-md p-4 flex items-center space-x-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-cyan-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM4.332 8.027a6.012 6.012 0 011.912-2.706C6.512 5.73 6.974 6 7.5 6A1.5 1.5 0 019 7.5V8a2 2 0 004 0 2 2 0 011.521-.962c.226-.06.445-.118.654-.17a.75.75 0 01.83.939 6.002 6.002 0 01-4.502 5.165 1.5 1.5 0 01-.663 2.059 4.502 4.502 0 01-6.107-3.44zm11.336-1.85a.75.75 0 00-.583.872 4.5 4.5 0 01-1.956 3.44 1.5 1.5 0 01-2.059.663 6.002 6.002 0 01-5.165-4.502.75.75 0 00-.939-.83c-.052.109-.109.222-.17.33a.75.75 0 00.872.583 4.5 4.5 0 013.44 1.956 1.5 1.5 0 01.663 2.059 6.002 6.002 0 01-4.502 5.165.75.75 0 00.583-.872c.109-.208.222-.41.33-.614a.75.75 0 00-.872-.583 4.5 4.5 0 01-1.956-3.44 1.5 1.5 0 01.663-2.059 6.002 6.002 0 015.165-4.502.75.75 0 00.83-.939c-.208-.109-.41-.222-.614-.33a.75.75 0 00-.583.872 4.5 4.5 0 01-3.44 1.956 1.5 1.5 0 01-2.059.663A6.002 6.002 0 015.165 4.5.75.75 0 006 3.917c.208.109.41.222.614.33a.75.75 0 00.872-.583 4.5 4.5 0 013.44-1.956 1.5 1.5 0 012.059-.663A6.002 6.002 0 0115.5 5.165.75.75 0 0016.083 6c-.109.208-.222.41-.33.614z" clip-rule="evenodd" />
        </svg>
        <h1 class="text-xl font-bold tracking-wider">Argo AI Ocean Explorer</h1>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex p-4 space-x-4 overflow-hidden">
        
        <!-- Left Panel: Map Visualization -->
        <div class="w-2/3 flex flex-col bg-gray-800 p-4 rounded-lg shadow-lg">
            <h2 class="text-lg font-semibold mb-2 text-cyan-300">Global Argo Float Positions</h2>
            <div id="map" class="flex-grow"></div>
        </div>

        <!-- Right Panel: Chat Interface -->
        <div class="w-1/3 flex flex-col bg-gray-800 rounded-lg shadow-lg">
            <div id="chat-container" class="flex flex-col h-full p-4">
                <h2 class="text-lg font-semibold mb-4 text-cyan-300">Ask a question about Ocean Data</h2>
                <!-- Messages Area -->
                <div id="chat-messages" class="flex-grow overflow-y-auto mb-4 space-y-4 pr-2">
                    <!-- Example Bot Message -->
                    <div class="flex items-start justify-start">
                        <div class="message-bubble bg-gray-700 p-3 rounded-lg rounded-bl-none">
                            <p class="text-sm">Hello! I am your Argo AI assistant. Ask me about ocean temperature, salinity, or float locations. For example: "Show me active floats in the Pacific Ocean."</p>
                        </div>
                    </div>
                </div>
                
                <!-- Input Area -->
                <div class="mt-auto">
                    <form id="chat-form" class="flex items-center space-x-2">
                        <input type="text" id="chat-input" placeholder="Type your message..." class="w-full bg-gray-700 border border-gray-600 rounded-full py-2 px-4 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
                        <button type="submit" class="bg-cyan-600 hover:bg-cyan-500 rounded-full p-2.5 text-white transition duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- 1. INITIALIZE THE MAP ---
        const map = L.map('map').setView([20, 0], 2); // Center on the globe

        // Add a tile layer from OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 18,
        }).addTo(map);

        // Example marker for an Argo float
        const argoFloat1 = L.marker([34.5, -40.2]).addTo(map)
            .bindPopup('Argo Float #1<br>Temp: 15.2Â°C<br>Salinity: 35.5 psu');


        // --- 2. HANDLE CHAT INTERACTION ---
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');

        chatForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const userMessage = chatInput.value.trim();

            if (userMessage) {
                // Add user message to chat window
                appendMessage(userMessage, 'user');
                chatInput.value = '';

                // Show a thinking indicator
                appendMessage('...', 'bot', true);

                // --- SEND MESSAGE TO BACKEND ---
                // In a real application, you would send the message to your FastAPI backend
                // and handle the response.
                sendMessageToBackend(userMessage);
            }
        });

        function appendMessage(text, sender, isThinking = false) {
            const messageWrapper = document.createElement('div');
            const messageBubble = document.createElement('div');
            const messageText = document.createElement('p');

            messageWrapper.classList.add('flex', 'items-start');
            messageBubble.classList.add('message-bubble', 'p-3', 'rounded-lg');
            messageText.classList.add('text-sm');
            messageText.textContent = text;
            
            if(isThinking) {
                messageBubble.id = 'thinking-bubble';
                messageText.innerHTML = '<span class="animate-pulse">Thinking...</span>';
            }

            if (sender === 'user') {
                messageWrapper.classList.add('justify-end');
                messageBubble.classList.add('bg-cyan-600', 'rounded-br-none');
            } else {
                messageWrapper.classList.add('justify-start');
                messageBubble.classList.add('bg-gray-700', 'rounded-bl-none');
            }

            messageBubble.appendChild(messageText);
            messageWrapper.appendChild(messageBubble);
            chatMessages.appendChild(messageWrapper);
            
            // Scroll to the bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function sendMessageToBackend(message) {
            // Replace with your actual backend API endpoint
            const apiUrl = 'http://127.0.0.1:8000/ask'; 
            
            // This is a MOCKUP of the API call.
            // You will need to build the Python backend for this to work.
            try {
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: message })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Remove the "Thinking..." bubble
                const thinkingBubble = document.getElementById('thinking-bubble');
                if(thinkingBubble) {
                    thinkingBubble.parentElement.remove();
                }

                // Append the real bot response
                appendMessage(data.answer, 'bot');

                // If the response contains map data, you would visualize it here
                if(data.visualization_data) {
                    // code to add markers or layers to the Leaflet map
                }

            } catch (error) {
                console.error("Error communicating with backend:", error);
                const thinkingBubble = document.getElementById('thinking-bubble');
                if(thinkingBubble) thinkingBubble.parentElement.remove();
                appendMessage("Sorry, I couldn't connect to the server. Please check the backend and try again.", 'bot');
            }
        }
    </script>
</body>
</html>
